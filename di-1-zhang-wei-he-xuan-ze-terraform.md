# 第1章 为何选择Terraform

代码在您的计算机上运行的代时候，代码刚刚测试通过的时候，当有人让您去部署代码的时候，这些情况下都意味着软件并未交付。 只有当您将软件交付给用户的时候，软件才算正式发布。 软件交付包括您为客户提供代码交付所需的所有工作，例如在生产服务器上运行该代码，使代码能够适应中断和流量峰值，以及保护代码免受攻击者攻击。 在深入了解Terraform的细节之前，有必要回顾下Terraform在哪些方面适合软件交付。 

在本章中，我将深入研究以下主题： 

•DevOps的崛起

 •基础设施即代码

 •基础设施即代码的好处

 •Terraform如何运作

 •Terraform与其他基础设施即代码工具的比较

## DevOps的崛起 

在不远的过去，如果你想建立一家软件公司，那你将不得不管理很多硬件。您可以设置机柜和机架，使用服务器加载它们，连接接线，安装冷却，构建冗余电源系统等等。你需要有一个团队，通常称为“运维团队“，致力于管理这些硬件，以及一个独立的团队，通常称为“开发团队“，专门用于编写软件。 

典型的开发团队执行应用程序构建，并将构建完的程序移交给运维团队。然后由运维团队决定如何部署和运行该应用程序。大多数情况下，这一环节是手动完成的。在某种程度上，这是不可避免的，因为大部分工作都与物理连接硬件（例如货架服务器，连接网络电缆）有关。但即使运维团队所做的工作，例如安装应用程序及其依赖项，通常也是通过在服务器上手动执行命令来完成的。 

这种情况短期内很有效，但随着公司的发展，你最终会遇到问题。由于发布是手动完成的，随着服务器数量的增加，发布变得缓慢，痛苦和不可预测。 运维团队偶尔会出错，所以你最终会得到“雪花服务器“，即其中一台服务器的配置与其他服务器配置不同，结果导致出错的情况增加。开发人员可能会说：“它可以在我的机器上运行！”，但是，停机频次和停机时间可能会大幅增加。 

运维团队在每次发布后的凌晨3点都对他们的寻呼机感到厌倦，将发布节奏减少到每周一次。然后每个月一次。然后每六个月一次。在两年一次的发布前几周，团队开始尝试将所有项目合并在一起，导致合并冲突的混乱。没人能稳定发布分支。团队之间开始互相指责，该公司陷入停顿。

如今，这一现象已经明显改观。许多公司不再管理自己的数据中心，而是转向云计算，利用Amazon Web Services（AWS），Azure和Google Cloud等服务。许多运维团队不是大量投资硬件，而是使用Chef，Puppet，Terraform和Docker等工具将所有时间花在软件上。许多系统管理员不是编写服务器和插入网络电缆，而是编写代码。 

因此，开发和运维团队都将大部分时间花在软件上，两个团队之间的区别正在变得模糊。虽然让一个独立的开发团队负责应用程序代码，而让运维团队负责代码交付可能依然可行，但很明显开发和运维需要更紧密地协同工作。这便是DevOps一词的来源。 

DevOps不是团队、职称或特定技术的名称。相反，它是一组流程，想法和技术。每个人对DevOps的定义都略有不同，但对于本书，我将使用以下内容： 

####          DevOps的目标是使软件交付更加高效。 

您可以持续集成代码并始终将其保持在可部署状态，而无需再经历历时好几天的代码合并。您可以每天部署代码数十次，甚至可以在每次提交后部署代码，而不是每月部署一次代码。您可以通过构建弹性，自我修复系统，并使用监控和警报来捕获无法自动解决的问题，从而避免出现持续故障和停机的状况。 

采用DevOps实践的公司所需要的成果是令人震惊。例如，Nordstrom发现，在将DevOps实践应用于他们的组织后，他们能够将每月交付的功能数量增加一倍，将缺陷减少50％，缩短交付周期（从产生想法到在生产环境运行代码）减少60％，并将生产环境故障数量减少60％～90％。在HP的LaserJet固件部门开始采用DevOps实践之后，开发人员开发新功能所花费的时间从5％增加到40％，总体开发成本降低了40％。 Etsy使用DevOps实践之后，一改原本部署压力大，频次低，故障率高的情况，实现了每天25～50次的持续部署。

DevOps有四个核心价值观：文化，自动化，测量和共享（可以缩写为CAMS）。本书并不是对DevOps的全面概述，因此我将只关注其中一个值：自动化。 自动化的目标是尽可能多地自动化交付软件。这意味着您是通过代码，而不是通过单击网页或手动执行shell命令来管理您的基础设施，这就是通常所说的基础设施即代码的含义。



基础设施即代码（IAC）背后的想法是您可以通过编写和执行代码的方式， 定义、部署和更新您的基础架构。 这是一个重要的思维方式的转变，您把所有的操作都视为软件，即使是对硬件进行操作（例如设置物理服务器）。 事实上，DevOps的一个重要功能，是您可以管理代码中的几乎所有内容，包括服务器，数据库， 网络，日志文件，应用程序配置，文档，自动化测试， 部署过程等。 

IAC工具有四大类： 

•临时脚本 

•配置管理工具 

•服务器模板工具

•编排工具

下面我们一次来看下这几大类。

## 临时脚本

自动化任何工作最直接的方法是写一个临时的脚本。 您可以手动执行任务，将其分解为离散的任务步骤，通过使用您最喜欢的脚本语言（例如Bash，Ruby，Python）来定义代码中的每一个步骤，并在服务器上执行该脚本，如图1-1所示。 

图1-1. 在服务器上运行临时脚本 

例如，有一个名为setup-webserver.sh的Bash脚本，它依次执行安装依赖项，从Git仓库拷贝代码，启动Apache Web服务器，并完成服务器的配置。

`＃更新apt-get缓存` 

`sudo apt-get update`

`＃安装PHP` 

`sudo apt-get install -y php`

`＃安装Apache`

`sudo apt-get install -y apache2`

`# Copy the code from repository`

`sudo git clone https://github.com/brikis98/php-app.git /var/www/html/app`

`# 启动Apache`

`sudo service apache2 start`

临时脚本的好处是你可以使用通用编程语言，您可以根据需要编写代码。但这也可能会带来很多问题。

而为IAC专门构建的工具则提供了简洁的API来完成复杂的任务，如果你使用的是通用编程语言，你可以为每个任务编写完全自定义的代码。此外，为IAC设计的工具，通常可以为您的代码强制执行特定的结构，而具有通用性的编程语言，则可以使每个开发人员都使用自己的风格来做一些不同的事情。如果仅仅只是运行八行代码来安装Apache脚本来说，这些问题都不是很重要，但如果您尝试使用临时脚本来管理数百台服务器，数据库，负载均衡器，网络配置等，那就很容易出现混乱。 

如果你曾经不得不维护别人的临时脚本仓库，你就会知道，维护成本有多高。临时脚本非常适合运行小规模的一次性任务，但是如果您要管理所有的基础设施即代码脚本，那么你应该使用专为此设计的IAC工具。 

## 配置管理工具 

Chef，Puppet，Ansible和SaltStack都是配置管理工具，它们的主要功能是安装和管理现有服务器上的软件。例如，下面是一个Ansible Role脚本，它的配置与上一节Apache Web服务器的配置相同 ：

`- name: Update the apt-get cache`

`apt:`

`update_cache: yes`

`- name: Install PHP`

`apt:`

`name: php`

`- name: Install Apache`

`apt:`

`name: apache2`

`- name: Copy the code from repository`

`git: repo=https://github.com/brikis98/php-app.git dest=/var/www/html/app`

`- name: Start Apache` 

  `service: name=apache2 state=started enabled=yes`

 上面这段代码类似于bash脚本，区别仅仅是Ansible将对文档和明确的命名参数，执行一致性和结构校验。 看下Ansible如何支持内置任务，例如使用安装包，使用git apt和check out命令。 虽然这段Ansible Role代码和Bash 脚本大小差不多，但是当您开始使用Ansible执行更高级的命令时，这种差异将会变得更加明显。 

而且，和临时脚本不同，后者是为在本地服务器上运行设计的，而Ansible和其他配置管理工具，则是专门设计用于管理大量远程服务器的，如图1-2所示。

例如，要将上面的Web服务器角色应用于5个服务器，首先要创建一个host文件，里面包含需要管理的远程服务器IP地址：

 `[Web服务器]` 

`11.11.11.11` 

`11.11.11.12` 

`11.11.11.13` 

`11.11.11.14` 

`11.11.11.15` 

接下来，您就可以定义Ansible Playbook：

`hosts: webservers`

`roles:`

  `- webserver`

接着，按如下方式执行playbook：

`ansible-playbook playbook.yml` 

## 服务器模板工具

配置管理的替代方案越来越受欢迎 最近是服务器模板工具，如Docker，Packer和Vagrant。代替 启动一堆服务器并通过运行相同的代码来配置它们 每一个，服务器模板工具背后的想法是创建一个服务器的图像 捕获操作系统，软件，完全独立的“快照” 文件和所有其他相关细节。您可以为每个图像指定唯一的版本号， 将映像部署到任何环境，并回滚到以前的版本（如果有的话） 出错。当然，要在所有服务器上部署映像，您仍然需要一些 其他IAC工具。例如，您可以使用Terraform，如下一节所示， 或者您可以使用Ansible，如图1-3所示。

如图1-4所示，两大类常用的处理镜像的工具： 

### 虚拟机（VM） 

虚拟机（VM）模拟整个计算机系统，包括硬件。 您运行虚拟机管理程序（如VMWare，VirtualBox或Parallels）来虚拟化底层CPU，内存，硬盘和网络。任何在虚拟机管理程序上运行的VM映像只能看到虚拟化硬件， 它与主机和任何其他VM映像之间是完全隔离的，并且在所有环境中都以完全相同的方式运行（例如您的计算机，QA 服务器，生产服务器等）。虚拟机的缺点是所有这些虚拟化程序，在CPU使用率，内存使用率和启动时间方面会产生大量开销。 您可以使用Packer和Vagrant等工具将VM映像定义为代码。 

### 容器（Container）

容器模拟操作系统的用户空间。你运行一个容器引擎，如Docker或CoreOS rkt，来创建孤立的进程、内存、挂载点和网络。您运行的任何容器（如Docker容器） 在容器引擎之上只能看到自己孤立的用户空间，所以它不能看到主机或其他容器，并且它将以完全相同的方式，在所有环境中运行（例如您的计算机，QA服务器，生产服务器等）。 由于容器直接在主机上运行，​​因此隔离不是像VM一样安全，但几乎它没有CPU或内存开销，并且容器可以在几毫秒内启动。 您可以使用Docker和CoreOs rkt等工具，将容器镜像定义为代码。

1图1-4。 两种主要的镜像类型：左侧是虚拟机，右侧是容器。 虚拟机虚拟化硬件，而容器仅虚拟化用户空间。

例如，这是一个创建AWS机器映像的Packer模板 （AMI），它可以在Amazon Web Services（AWS）上运行的VM映像：

`{`

    `"builders": [{`

    `"ami_name": "packer-example",`

    `"instance_type": "t2.micro",`

    `"region": "us-east-1",`

    `"type": "amazon-ebs",`

    `"source_ami": "ami-40d28157",`

    `"ssh_username": "ubuntu"`

  `}],`

    `"provisioners": [{`

    `"type": "shell",`

    `"inline": [`

    `"sudo apt-get update",`

    `"sudo apt-get install -y php",`

    `"sudo apt-get install -y apache2",`

    `"sudo git clone https://github.com/brikis98/php-app.git /var/www/html/app"`

        `]`

      `}]`

    `}`

此Packer模板配置和您在之前看到的Apache Web服务器配置相同，唯一的区别：这个Packer模板将不启动Apache Web服务器（如通过调用sudo service apache2 start）。

##  基础设施即代码

 

## 基础设施即代码的好处



##  Terraform如何运作

 

## Terraform与其他基础设施即代码工具的比较

基础设施即代码（IAC）很完美，但如何选择IAC工具的过程却是件令人头疼的工作。许多IAC工具功能上存在着重叠。其中部分工具是开源的，而另外一些工具则提供商业支持。除非你自己知道如何选择，否则究竟应该用什么标准来选择IAC工具呢？

更令人难以理解的是，关于这些工具间的比较，大多数情况下只列出了每个工具的一般属性，并且似乎每种工具都能完成你需要完成的工作。虽然这在技术上是正确的，但实际上并没有太大帮助。这有点像告诉一个编程新手，你可以同样成功地用PHP，C或汇编建立一个网站 - 一个技术上真实的陈述，但是却省略了大量有助于作出正确决定的信息。

接下来，我将对最流行的配置管理和编排工具：Terraform，Chef，Pup pet，Ansible，SaltStack，CloudFormation和OpenStack Heat等进行详细地比较。目标是要说明为什么我们选择Terraform作为IAC工具。以及从某种意义上说，这也是为什么我要写这本书的目的。如同其他技术决策一样，选取IAC工具涉及到权衡和优先级，虽然您的特定优先级可能与我的不同，但我希望通过分享这个思考过程，来帮助您做出自己的决定。 

以下在决策过程中，需要考虑的主要权衡因素：

配置管理与编排

可变基础架构与不可变基础架构

程序语言与声明语言

客户端/服务器断架构与仅客户端架构

大型社区与小型社区

成熟与前沿技术

